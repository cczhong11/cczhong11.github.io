<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.115.2">

    
    
    

<title>Learn LlamaIndex: Key Components • TC blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Learn LlamaIndex: Key Components"/>
<meta name="twitter:description" content="Learn llamaindex via source code"/>

<meta property="og:title" content="Learn LlamaIndex: Key Components" />
<meta property="og:description" content="Learn llamaindex via source code" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.tczhong.com/posts/llm/key_component_in_llama_index/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-05-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-05-24T00:00:00+00:00" /><meta property="og:site_name" content="TC blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">








<link rel="stylesheet" href="https://www.tczhong.com/scss/hyde-hyde.3081c4981fb69a2783dd36ecfdd0e6ba7a158d4cbfdd290ebce8f78ba0469fc6.css" integrity="sha256-MIHEmB&#43;2mieD3Tbs/dDmunoVjUy/3SkOvOj3i6BGn8Y=">


<link rel="stylesheet" href="https://www.tczhong.com/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.tczhong.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://www.tczhong.com/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.tczhong.com/">TC blog</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://avatars2.githubusercontent.com/u/7358252?s=460&amp;v=4" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         I am who I am. Love LLM and AI Agent. 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">TC blog</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="https://www.tczhong.com/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/about/hello">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/tianchen_zhong.pdf">
						<span>My Resume</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/posts/project/index.html">
						<span>Project</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	
	
	<a href="https://github.com/cczhong11" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/tianchen-zhong" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/7112540" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="mailto:tczhong24@gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Learn LlamaIndex: Key Components</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> May 5, 2024
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/llamaindex">LLAMAINDEX</a>
              •
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/llm">LLM</a>
              •
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/llmops">LLMOPS</a>
              
          
      
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 9 min read
</div>


  </header>
  
  
  <div class="post">
    <h2 id="overview">Overview</h2>
<p>Llamaindex is a very good library to do RAG with LLM however it is very hard to learn since the function is very high-level and as a beginner it is hard to understand what each function is doing. In this post, I will discuss the key components with source code and example code.</p>
<p>To do a simple RAG, the following components are the most basic one:</p>
<ul>
<li>Readers</li>
<li>Indices</li>
<li>QueryRunner</li>
</ul>
<p>The doc will use the 0.2.17 since this is the oldest tag version and it will be easy to understand the key concept for the whole llamaindex.</p>
<h2 id="reader">Reader</h2>
<p>The basic class is <a href="https://github.com/run-llama/llama_index/blob/285e0a300e1b740acec2e9435250f40766819d5a/gpt_index/readers/base.py#L10">BaseReader</a> and it has one main abstract function is</p>
<pre tabindex="0"><code>def load_data(self, *args: Any, **load_kwargs: Any) -&gt; List[Document]
</code></pre><p>So what is Document object? It is a generic interface for a data document. And it inherits from BaseDocument.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Document</span>(BaseDocument):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Generic interface for a data document.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This document connects to data sources.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseDocument</span>(DataClassJsonMixin):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Base document.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Generic abstract interfaces that captures both index structs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    as well as documents.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    text: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    doc_id: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    embedding: Optional[List[float]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># extra fields</span>
</span></span><span style="display:flex;"><span>    extra_info: Optional[Dict[str, Any]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p>We can see each BaseDocument saved text, doc_id, embedding and extra_info field.
DataClassJsonMixin is a class that can dump staff to json easily.</p>
<p>So we can see that Reader can read document and save to Document object. Then how it exactly happened? Let&rsquo;s take a look at <a href="https://github.com/run-llama/llama_index/blob/56e2523518ae2f1c694a99ecba323f7ea0ea76ed/gpt_index/readers/file/base.py#L27-L51">SimpleDirectoryReader</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleDirectoryReader</span>(BaseReader):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Simple directory reader.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Can read files into separate documents, or concatenates
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    files into one document text.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        input_dir (str): Path to the directory.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        input_files (List): List of file paths to read (Optional; overrides input_dir)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        exclude_hidden (bool): Whether to exclude hidden files (dotfiles).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        errors (str): how encoding and decoding errors are to be handled,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              see https://docs.python.org/3/library/functions.html#open
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        recursive (bool): Whether to recursively search in subdirectories.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            False by default.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        required_exts (Optional[List[str]]): List of required extensions.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            Default is None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        file_extractor (Optional[Dict[str, BaseParser]]): A mapping of file
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            extension to a BaseParser class that specifies how to convert that file
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            to text. See DEFAULT_FILE_EXTRACTOR.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        num_files_limit (Optional[int]): Maximum number of files to read.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            Default is None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        file_metadata (Optional[Callable[str, Dict]]): A function that takes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            in a filename and returns a Dict of metadata for the Document.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            Default is None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><p>Here we can define the place to read file, the extensions to read and how to extract content and also file_metadata as a callable.</p>
<p>In the load_data, it basically go through the file list and use specific parser and load metadata using the file metadata. We can also concatenate all to one document if needed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_data</span>(self, concatenate: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>) <span style="color:#f92672">-&gt;</span> List[Document]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Load data from the input directory.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            concatenate (bool): whether to concatenate all files into one document.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                If set to True, file metadata is ignored.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                False by default.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            List[Document]: A list of documents.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        data: Union[str, List[str]] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        data_list: List[str] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        metadata_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> input_file <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>input_files:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> input_file<span style="color:#f92672">.</span>suffix <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>file_extractor:
</span></span><span style="display:flex;"><span>                parser <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>file_extractor[input_file<span style="color:#f92672">.</span>suffix]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> parser<span style="color:#f92672">.</span>parser_config_set:
</span></span><span style="display:flex;"><span>                    parser<span style="color:#f92672">.</span>init_parser()
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_file(input_file, errors<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>errors)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># do standard read</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">with</span> open(input_file, <span style="color:#e6db74">&#34;r&#34;</span>, errors<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>errors) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                    data <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> isinstance(data, List):
</span></span><span style="display:flex;"><span>                data_list<span style="color:#f92672">.</span>extend(data)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                data_list<span style="color:#f92672">.</span>append(str(data))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>file_metadata <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                metadata_list<span style="color:#f92672">.</span>append(self<span style="color:#f92672">.</span>file_metadata(str(input_file)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> concatenate:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> [Document(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(data_list))]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>file_metadata <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> [Document(d, extra_info<span style="color:#f92672">=</span>m) <span style="color:#66d9ef">for</span> d, m <span style="color:#f92672">in</span> zip(data_list, metadata_list)]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> [Document(d) <span style="color:#66d9ef">for</span> d <span style="color:#f92672">in</span> data_list]
</span></span></code></pre></div><h2 id="indices">Indices</h2>
<p>This is the key part of the whole project and since it is called llamaindex.</p>
<p>Lots of things can be learned in this part. Here I can only go through the basic examples.</p>
<h3 id="short-example">Short Example</h3>
<p>Here I will show how people can use it and then go deep.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>documents <span style="color:#f92672">=</span> SimpleDirectoryReader(<span style="color:#e6db74">&#39;data&#39;</span>)<span style="color:#f92672">.</span>load_data()
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> GPTTreeIndex(documents)
</span></span><span style="display:flex;"><span>new_index<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;What is the name of the professional women&#39;s basketball team in New York City?&#34;</span>)
</span></span></code></pre></div><p>Looks very simple, right? Let&rsquo;s go deep.</p>
<h3 id="gpttreeindex-class">GPTTreeIndex class</h3>
<p>The class for GPTTreeIndex is defined as <code>GPTTreeIndex(BaseGPTIndex[IndexGraph])</code>.</p>
<p>For <code>BaseGPTIndex</code> is defined as <code>class BaseGPTIndex(Generic[IS])</code> and IS is <code>IS = TypeVar(&quot;IS&quot;, bound=IndexStruct)</code></p>
<p>For <code>IndexStruct</code> is defined as <code>class IndexStruct(BaseDocument, DataClassJsonMixin)</code></p>
<p>Here we can see it is also a BaseDocument for IndexStruct, which means have the following field:</p>
<ul>
<li>text: Optional[str] = None</li>
<li>doc_id: Optional[str] = None</li>
<li>embedding: Optional[List[float]] = None</li>
<li>extra_info: Optional[Dict[str, Any]] = None</li>
</ul>
<p><code>IndexGraph</code> is defined as <code>class IndexGraph(IndexStruct)</code> and Node is also defined as <code>Node(IndexStruct)</code></p>
<p>Here is a graph generated by chatgpt to show the relationship.</p>
<p>A lot of abstraction, what each layer defined?</p>
<ul>
<li>IndexStruct is empty</li>
<li>Node is Base struct used in most indices.
<ul>
<li>index: int = 0</li>
<li>child_indices: Set[int] = field(default_factory=set)</li>
<li>embedding: Optional[List[float]] = None</li>
<li>ref_doc_id: Optional[str] = None</li>
<li>node_info: Optional[Dict[str, Any]] = None</li>
<li>looks like embedding got redefine since it is defined in BaseDocument</li>
</ul>
</li>
<li>IndexGraph is a graph representing the tree-structured index.
<ul>
<li>defined the following fields
<ul>
<li>all_nodes: Dict[int, Node]</li>
<li>root_nodes: Dict[int, Node]</li>
<li>here <strong>key</strong> is a index for each node and it is global node index for the whole index object</li>
</ul>
</li>
</ul>
</li>
<li>BaseGPTIndex is the Base GPT Index
<ul>
<li>documents: Optional[Sequence[DOCUMENTS_INPUT]]</li>
<li>index_struct: Optional[IS]</li>
<li>llm_predictor: Optional[LLMPredictor]</li>
<li>embed_model: Optional[BaseEmbedding]</li>
<li>docstore: Optional[DocumentStore]</li>
<li>prompt_helper: Optional[PromptHelper]</li>
<li>chunk_size_limit: Optional[int]</li>
<li>it can load documents to build index</li>
<li>add/update/delete doc from docid</li>
<li>use QueryRunner to query index based on user question</li>
</ul>
</li>
<li>GPTTreeIndex
<ul>
<li>use GPTTreeIndexBuilder to build tree</li>
</ul>
</li>
</ul>
<p>There are also other index, will discuss in other posts.</p>
<h3 id="gpttreeindexbuilder">GPTTreeIndexBuilder</h3>
<p>Let&rsquo;s look deep in GPTTreeIndexBuilder.</p>
<p>The key is in the build_index_from_nodes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_index_from_nodes</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        cur_nodes: Dict[int, Node],
</span></span><span style="display:flex;"><span>        all_nodes: Dict[int, Node],
</span></span><span style="display:flex;"><span>        verbose: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> Dict[int, Node]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Consolidates chunks recursively, in a bottoms-up fashion.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        cur_node_list <span style="color:#f92672">=</span> get_sorted_node_list(cur_nodes) <span style="color:#75715e"># sort based on the node index</span>
</span></span><span style="display:flex;"><span>        cur_index <span style="color:#f92672">=</span> len(all_nodes) 
</span></span><span style="display:flex;"><span>        new_node_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        print(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&gt; Building index from nodes: </span><span style="color:#e6db74">{</span>len(cur_nodes) <span style="color:#f92672">//</span> self<span style="color:#f92672">.</span>num_children<span style="color:#e6db74">}</span><span style="color:#e6db74"> chunks&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(cur_node_list), self<span style="color:#f92672">.</span>num_children):
</span></span><span style="display:flex;"><span>            cur_nodes_chunk <span style="color:#f92672">=</span> cur_node_list[i : i <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>num_children]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## get num_children text chunk from cur_node_list</span>
</span></span><span style="display:flex;"><span>            text_chunk <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_prompt_helper<span style="color:#f92672">.</span>get_text_from_nodes(
</span></span><span style="display:flex;"><span>                cur_nodes_chunk, prompt<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>summary_prompt
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## use LLM to summary the text</span>
</span></span><span style="display:flex;"><span>            new_summary, _ <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_llm_predictor<span style="color:#f92672">.</span>predict(
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>summary_prompt, context_str<span style="color:#f92672">=</span>text_chunk
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## get new node and save child node</span>
</span></span><span style="display:flex;"><span>            new_node <span style="color:#f92672">=</span> Node(
</span></span><span style="display:flex;"><span>                text<span style="color:#f92672">=</span>new_summary,
</span></span><span style="display:flex;"><span>                index<span style="color:#f92672">=</span>cur_index,
</span></span><span style="display:flex;"><span>                child_indices<span style="color:#f92672">=</span>{n<span style="color:#f92672">.</span>index <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> cur_nodes_chunk},
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            new_node_dict[cur_index] <span style="color:#f92672">=</span> new_node
</span></span><span style="display:flex;"><span>            cur_index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">## update all nodes</span>
</span></span><span style="display:flex;"><span>        all_nodes<span style="color:#f92672">.</span>update(new_node_dict)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(new_node_dict) <span style="color:#f92672">&lt;=</span> self<span style="color:#f92672">.</span>num_children:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> new_node_dict
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># recursive build node</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>build_index_from_nodes(new_node_dict, all_nodes)
</span></span></code></pre></div><p>root_nodes is the return of this function.</p>
<h2 id="queryrunner">QueryRunner</h2>
<p>QueryRunner can take in an index and prompt and get answer based on the index.</p>
<p>It is also very complicated, let&rsquo;s following the high level class strcture.</p>
<p><code>QueryRunner</code> is defined as <code>class QueryRunner(BaseQueryRunner)</code></p>
<p>BaseQueryRunner only defined one abstruct function which is <code>def query(self, query: str, index_struct: IndexStruct) -&gt; Response</code></p>
<p><code>Response</code> is defined as, so we can know how we got this response.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Response</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Response.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Attributes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        response: The response text.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    response: Optional[str]
</span></span><span style="display:flex;"><span>    source_nodes: List[SourceNode] <span style="color:#f92672">=</span> field(default_factory<span style="color:#f92672">=</span>list)
</span></span><span style="display:flex;"><span>    extra_info: Optional[Dict[str, Any]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p>In <code>QueryRunner</code>, we can see how query function got implemented:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">query</span>(self, query_str: str, index_struct: IndexStruct) <span style="color:#f92672">-&gt;</span> Response:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Run query.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        index_struct_type <span style="color:#f92672">=</span> IndexStructType<span style="color:#f92672">.</span>from_index_struct(index_struct)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index_struct_type <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_config_dict:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;IndexStructType </span><span style="color:#e6db74">{</span>index_struct_type<span style="color:#e6db74">}</span><span style="color:#e6db74"> not in config_dict&#34;</span>)
</span></span><span style="display:flex;"><span>        config <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_config_dict[index_struct_type]
</span></span><span style="display:flex;"><span>        mode <span style="color:#f92672">=</span> config<span style="color:#f92672">.</span>query_mode
</span></span><span style="display:flex;"><span>        query_cls <span style="color:#f92672">=</span> get_query_cls(index_struct_type, mode)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># if recursive, pass self as query_runner to each individual query</span>
</span></span><span style="display:flex;"><span>        query_runner <span style="color:#f92672">=</span> self <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_recursive <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        query_kwargs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_query_kwargs(config)
</span></span><span style="display:flex;"><span>        query_obj <span style="color:#f92672">=</span> query_cls(
</span></span><span style="display:flex;"><span>            index_struct,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">**</span>query_kwargs,
</span></span><span style="display:flex;"><span>            query_runner<span style="color:#f92672">=</span>query_runner,
</span></span><span style="display:flex;"><span>            docstore<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>_docstore,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> query_obj<span style="color:#f92672">.</span>query(query_str, verbose<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>_verbose)
</span></span></code></pre></div><p>So the key for its actually defined in <code>get_query_cls</code> and keep this post simple, here it could return one <code>GPTTreeIndexLeafQuery</code>.</p>
<p><code>GPTTreeIndexLeafQuery</code> is defined as <code>class GPTTreeIndexLeafQuery(BaseGPTIndexQuery[IndexGraph])</code></p>
<p>BaseGPTIndexQuery is defined as <code>class BaseGPTIndexQuery(Generic[IS])</code>.</p>
<ul>
<li>BaseGPTIndexQuery defines the following properties:
<ul>
<li>index_struct: IS</li>
<li>llm_predictor: Optional[LLMPredictor]</li>
<li>prompt_helper: Optional[PromptHelper]</li>
<li>embed_model: Optional[BaseEmbedding]</li>
<li>docstore: Optional[DocumentStore]</li>
<li>query_runner: Optional[BaseQueryRunner]</li>
<li>required_keywords: Optional[List[str]]</li>
<li>exclude_keywords: Optional[List[str]]</li>
<li>response_mode: ResponseMode = ResponseMode.DEFAULT,</li>
<li>text_qa_template: Optional[QuestionAnswerPrompt]</li>
<li>refine_template: Optional[RefinePrompt]</li>
<li>include_summary: bool = False,</li>
<li>response_kwargs: Optional[Dict]</li>
<li>similarity_cutoff: Optional[float]</li>
<li>_query function that can be overloaded by sub classes</li>
<li>query function take _query result and build source nodes for Response class</li>
<li>default _query is defined as following
<ul>
<li>
<ol>
<li>get_nodes_and_similarities_for_response</li>
</ol>
</li>
<li>
<ol start="2">
<li>_should_use_node check cut off</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>For GPTTreeIndexLeafQuery, the _query function is defined as following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_query</span>(self, query_str: str, verbose: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>) <span style="color:#f92672">-&gt;</span> Response:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Answer a query.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># NOTE: this overrides the _query method in the base class</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&gt; Starting query: </span><span style="color:#e6db74">{</span>query_str<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        source_builder <span style="color:#f92672">=</span> ResponseSourceBuilder()
</span></span><span style="display:flex;"><span>        response_str <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_query_level(
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index_struct<span style="color:#f92672">.</span>root_nodes,
</span></span><span style="display:flex;"><span>            query_str,
</span></span><span style="display:flex;"><span>            source_builder,
</span></span><span style="display:flex;"><span>            level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            verbose<span style="color:#f92672">=</span>verbose,
</span></span><span style="display:flex;"><span>        )<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Response(response_str, source_nodes<span style="color:#f92672">=</span>source_builder<span style="color:#f92672">.</span>get_sources())
</span></span></code></pre></div><p>So we query the root nodes for first.</p>
<p>In _query_level :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_query_level</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        cur_nodes: Dict[int, Node],
</span></span><span style="display:flex;"><span>        query_str: str,
</span></span><span style="display:flex;"><span>        source_builder: ResponseSourceBuilder,
</span></span><span style="display:flex;"><span>        level: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        verbose: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Answer a query recursively.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        cur_node_list <span style="color:#f92672">=</span> get_sorted_node_list(cur_nodes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>child_branch_factor <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            query_template <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>query_template<span style="color:#f92672">.</span>partial_format(
</span></span><span style="display:flex;"><span>                num_chunks<span style="color:#f92672">=</span>len(cur_node_list), query_str<span style="color:#f92672">=</span>query_str
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># numbered_node_text is a str and contains all nodes info</span>
</span></span><span style="display:flex;"><span>            numbered_node_text <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_prompt_helper<span style="color:#f92672">.</span>get_numbered_text_from_nodes(
</span></span><span style="display:flex;"><span>                cur_node_list, prompt<span style="color:#f92672">=</span>query_template
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># get LLM response and result is node index</span>
</span></span><span style="display:flex;"><span>            response, formatted_query_prompt <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_llm_predictor<span style="color:#f92672">.</span>predict(
</span></span><span style="display:flex;"><span>                query_template,
</span></span><span style="display:flex;"><span>                context_list<span style="color:#f92672">=</span>numbered_node_text,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># ignore here in the post</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># regex to find number</span>
</span></span><span style="display:flex;"><span>        numbers <span style="color:#f92672">=</span> extract_numbers_given_response(response, n<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>child_branch_factor)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        result_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> number_str <span style="color:#f92672">in</span> numbers:
</span></span><span style="display:flex;"><span>            number <span style="color:#f92672">=</span> int(number_str)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> number <span style="color:#f92672">&gt;</span> len(cur_node_list):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> verbose:
</span></span><span style="display:flex;"><span>                    print(
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&gt;[Level </span><span style="color:#e6db74">{</span>level<span style="color:#e6db74">}</span><span style="color:#e6db74">] Invalid response: </span><span style="color:#e6db74">{</span>response<span style="color:#e6db74">}</span><span style="color:#e6db74"> - &#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;number </span><span style="color:#e6db74">{</span>number<span style="color:#e6db74">}</span><span style="color:#e6db74"> out of range&#34;</span>
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># number is 1-indexed, so subtract 1</span>
</span></span><span style="display:flex;"><span>            selected_node <span style="color:#f92672">=</span> cur_node_list[number <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&gt;[Level </span><span style="color:#e6db74">{</span>level<span style="color:#e6db74">}</span><span style="color:#e6db74">] Selected node: &#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[</span><span style="color:#e6db74">{</span>number<span style="color:#e6db74">}</span><span style="color:#e6db74">]/[</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">.</span>join([str(int(n)) <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> numbers])<span style="color:#e6db74">}</span><span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> verbose:
</span></span><span style="display:flex;"><span>                summary_text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join(selected_node<span style="color:#f92672">.</span>get_text()<span style="color:#f92672">.</span>splitlines())
</span></span><span style="display:flex;"><span>                fmt_summary_text <span style="color:#f92672">=</span> truncate_text(summary_text, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>                print(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&gt;[Level </span><span style="color:#e6db74">{</span>level<span style="color:#e6db74">}</span><span style="color:#e6db74">] Node &#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[</span><span style="color:#e6db74">{</span>number<span style="color:#e6db74">}</span><span style="color:#e6db74">] Summary text: </span><span style="color:#e6db74">{</span>fmt_summary_text<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># query the select node child</span>
</span></span><span style="display:flex;"><span>            result_response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_query_with_selected_node(
</span></span><span style="display:flex;"><span>                selected_node,
</span></span><span style="display:flex;"><span>                query_str,
</span></span><span style="display:flex;"><span>                source_builder,
</span></span><span style="display:flex;"><span>                prev_response<span style="color:#f92672">=</span>result_response,
</span></span><span style="display:flex;"><span>                level<span style="color:#f92672">=</span>level,
</span></span><span style="display:flex;"><span>                verbose<span style="color:#f92672">=</span>verbose,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># result_response should not be None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> cast(str, result_response)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_query_with_selected_node</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        selected_node: Node,
</span></span><span style="display:flex;"><span>        query_str: str,
</span></span><span style="display:flex;"><span>        source_builder: ResponseSourceBuilder,
</span></span><span style="display:flex;"><span>        prev_response: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        level: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        verbose: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get response for selected node.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        If not leaf node, it will recursively call _query on the child nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        If prev_response is provided, we will update prev_response with the answer.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># if no child, add source node to source_builder</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(selected_node<span style="color:#f92672">.</span>child_indices) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            response_builder <span style="color:#f92672">=</span> ResponseBuilder(
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>_prompt_helper,
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>_llm_predictor,
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>text_qa_template,
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>refine_template,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            source_builder<span style="color:#f92672">.</span>add_node(selected_node)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># use response builder to get answer from node</span>
</span></span><span style="display:flex;"><span>            node_text, _ <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_text_from_node(
</span></span><span style="display:flex;"><span>                query_str, selected_node, verbose<span style="color:#f92672">=</span>verbose, level<span style="color:#f92672">=</span>level
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            cur_response <span style="color:#f92672">=</span> response_builder<span style="color:#f92672">.</span>get_response_over_chunks(
</span></span><span style="display:flex;"><span>                query_str, [node_text], prev_response<span style="color:#f92672">=</span>prev_response, verbose<span style="color:#f92672">=</span>verbose
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> verbose:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&gt;[Level </span><span style="color:#e6db74">{</span>level<span style="color:#e6db74">}</span><span style="color:#e6db74">] Current answer response: </span><span style="color:#e6db74">{</span>cur_response<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># query next level with all child node</span>
</span></span><span style="display:flex;"><span>            cur_response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_query_level(
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    i: self<span style="color:#f92672">.</span>index_struct<span style="color:#f92672">.</span>all_nodes[i]
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> selected_node<span style="color:#f92672">.</span>child_indices
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                query_str,
</span></span><span style="display:flex;"><span>                source_builder,
</span></span><span style="display:flex;"><span>                level<span style="color:#f92672">=</span>level <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                verbose<span style="color:#f92672">=</span>verbose,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> prev_response <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> cur_response
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># concat the prev response with current response with LLM</span>
</span></span><span style="display:flex;"><span>            context_msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join([selected_node<span style="color:#f92672">.</span>get_text(), cur_response])
</span></span><span style="display:flex;"><span>            cur_response, formatted_refine_prompt <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_llm_predictor<span style="color:#f92672">.</span>predict(
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>refine_template,
</span></span><span style="display:flex;"><span>                query_str<span style="color:#f92672">=</span>query_str,
</span></span><span style="display:flex;"><span>                existing_answer<span style="color:#f92672">=</span>prev_response,
</span></span><span style="display:flex;"><span>                context_msg<span style="color:#f92672">=</span>context_msg,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> verbose:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&gt;[Level </span><span style="color:#e6db74">{</span>level<span style="color:#e6db74">}</span><span style="color:#e6db74">] Refine prompt: </span><span style="color:#e6db74">{</span>formatted_refine_prompt<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&gt;[Level </span><span style="color:#e6db74">{</span>level<span style="color:#e6db74">}</span><span style="color:#e6db74">] Current refined response: </span><span style="color:#e6db74">{</span>cur_response<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> cur_response
</span></span></code></pre></div><h2 id="summary">Summary</h2>
<p>this is a deep dive for basic component in llamaindex and I believe it is a good start to learn the whole project and help me to use it.</p>
<p>There is a lot of things we can set to tune to improve its performance on our own project. The only way to learn is to read the code, or use llamaindex and llm to understand the code repo quickly.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="https://www.tczhong.com/posts/llm/aider_learning/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Learn Aider: AI Coder</span>
    </a>
    
    
    <a href="https://www.tczhong.com/posts/llm/ai_replace_software_engineer_job/" class="navigation-next">
      <span class="navigation-tittle">Will AI Replace Software Engineers? A Look at the Latest Industry Trends</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'tczhong';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
