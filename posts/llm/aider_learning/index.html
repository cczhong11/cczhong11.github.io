<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.115.2">

    
    
    

<title>Learn Aider: AI Coder • TC blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Learn Aider: AI Coder"/>
<meta name="twitter:description" content="Learn Aider via source code"/>

<meta property="og:title" content="Learn Aider: AI Coder" />
<meta property="og:description" content="Learn Aider via source code" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.tczhong.com/posts/llm/aider_learning/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-04-20T00:00:00+00:00" /><meta property="og:site_name" content="TC blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">








<link rel="stylesheet" href="https://www.tczhong.com/scss/hyde-hyde.3081c4981fb69a2783dd36ecfdd0e6ba7a158d4cbfdd290ebce8f78ba0469fc6.css" integrity="sha256-MIHEmB&#43;2mieD3Tbs/dDmunoVjUy/3SkOvOj3i6BGn8Y=">


<link rel="stylesheet" href="https://www.tczhong.com/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.tczhong.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://www.tczhong.com/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.tczhong.com/">TC blog</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://avatars2.githubusercontent.com/u/7358252?s=460&amp;v=4" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         I am who I am. Love Cloud and Data science 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">TC blog</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="https://www.tczhong.com/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/about/hello">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/tianchen_zhong.pdf">
						<span>My Resume</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/posts/project/index.html">
						<span>Project</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	
	
	<a href="https://github.com/cczhong11" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/tianchen-zhong" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/7112540" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="mailto:tczhong24@gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Learn Aider: AI Coder</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Apr 4, 2024
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/agents">AGENTS</a>
              •
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/aider">AIDER</a>
              •
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/llm">LLM</a>
              •
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/llmops">LLMOPS</a>
              
          
      
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 5 min read
</div>


  </header>
  
  
  <div class="post">
    <h2 id="overview">Overview</h2>
<p>This blog will document my journey of reading the source code of Aider. I will explore the basic structure of the repository and highlight key learnings. Aider has an official blog and documentation that includes insights from the author.</p>
<h2 id="main">Main</h2>
<p>In the main function, Aider functions as a CLI tool. It creates a coder object and initiates coder.run(). If a Git repository doesn’t already exist, it will set one up for you. The io object helps configure the terminal, allowing for reading/writing text and even reading images.</p>
<p>The main logic resides in the coder class.</p>
<h2 id="coder">Coder</h2>
<p>Inside the <code>run()</code> method, there&rsquo;s a <code>while</code> loop:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> new_user_message:
</span></span><span style="display:flex;"><span>    new_user_message <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>send_new_user_message(new_user_message)
</span></span></code></pre></div><p>Within <code>send_new_user_message</code>, the following steps are executed:</p>
<ol>
<li>
<p><strong>Formatted message:</strong></p>
<ul>
<li>Retrieve multiple system prompts.</li>
<li>Obtain related code snippets from <code>repomap</code>.</li>
<li>Count tokens.</li>
</ul>
</li>
<li>
<p><strong>Send message to LLM:</strong></p>
<ul>
<li>Send the formatted message to the Language Model.</li>
</ul>
</li>
<li>
<p><strong>Get output and apply changes:</strong></p>
<ul>
<li>Receive the output and make the necessary code changes.</li>
</ul>
</li>
</ol>
<p>There are three main coder types:</p>
<ul>
<li><code>EditBlockCoder</code></li>
<li><code>UnifiedDiffCoder</code></li>
<li><code>WholeFileCoder</code></li>
</ul>
<p>Only GPT-4 and Claude 3 can provide unified diff (udiff) output, which is the most efficient way to update the code.</p>
<p>The high-level idea is clear, but there is a lot of code related to input/output and error handling.</p>
<p>The key part of this project is the <code>repomap</code>. Let&rsquo;s dive into it.</p>
<h2 id="coder-1">Coder</h2>
<p>Insider run(), it is a while loop</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> new_user_message:
</span></span><span style="display:flex;"><span>    new_user_message <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>send_new_user_message(new_user_message)
</span></span></code></pre></div><p>Inside send_new_user_message, it will do following things:</p>
<ol>
<li>formatted message:
<ol>
<li>get lots of system prompt</li>
<li>get related codes from repomap</li>
<li>count token</li>
</ol>
</li>
<li>send message to LLM</li>
<li>get output and do change</li>
</ol>
<p>There are three main coder:</p>
<ul>
<li>EditBlockCoder</li>
<li>UnifiedDiffCoder</li>
<li>WholeFileCoder</li>
</ul>
<p>only gpt4 and claude3 can provide udiff output and it is most efficient way to update the code.</p>
<p>The highlevel idea is very clear but there is a lot of codes related to input/output, error handling.</p>
<p>The key part of this project is the repomap part. Let&rsquo;s dive into it.</p>
<h2 id="repo">Repo</h2>
<p>In repomap.py, the main function is get_repo_map, with the main logic in get_ranked_tags. Here, chatfiles are the files to be updated, and otherfiles are all other files in the repository.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_repo_map</span>(self, chat_files, other_files):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        files_listing <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_ranked_tags_map(chat_files, other_files)
</span></span><span style="display:flex;"><span>        num_tokens <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>token_count(files_listing)
</span></span><span style="display:flex;"><span>        repo_content <span style="color:#f92672">+=</span> files_listing
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> repo_content
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_ranked_tags_map</span>(self, chat_files, other_files):
</span></span><span style="display:flex;"><span>        ranked_tags <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_ranked_tags(chat_fnames, other_fnames)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        num_tags <span style="color:#f92672">=</span> len(ranked_tags)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        lower_bound <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        upper_bound <span style="color:#f92672">=</span> num_tags
</span></span><span style="display:flex;"><span>        best_tree <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        chat_rel_fnames <span style="color:#f92672">=</span> [self<span style="color:#f92672">.</span>get_rel_fname(fname) <span style="color:#66d9ef">for</span> fname <span style="color:#f92672">in</span> chat_fnames]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> lower_bound <span style="color:#f92672">&lt;=</span> upper_bound:
</span></span><span style="display:flex;"><span>            middle <span style="color:#f92672">=</span> (lower_bound <span style="color:#f92672">+</span> upper_bound) <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>            tree <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>to_tree(ranked_tags[:middle], chat_rel_fnames)
</span></span><span style="display:flex;"><span>            num_tokens <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>token_count(tree)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> num_tokens <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>max_map_tokens:
</span></span><span style="display:flex;"><span>                best_tree <span style="color:#f92672">=</span> tree
</span></span><span style="display:flex;"><span>                lower_bound <span style="color:#f92672">=</span> middle <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                upper_bound <span style="color:#f92672">=</span> middle <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> best_tree
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_ranked_tags</span>(self, chat_fnames, other_fnames):
</span></span><span style="display:flex;"><span>        defines <span style="color:#f92672">=</span> defaultdict(set)
</span></span><span style="display:flex;"><span>        references <span style="color:#f92672">=</span> defaultdict(list)
</span></span><span style="display:flex;"><span>        definitions <span style="color:#f92672">=</span> defaultdict(set)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        personalization <span style="color:#f92672">=</span> dict()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        fnames <span style="color:#f92672">=</span> set(chat_fnames)<span style="color:#f92672">.</span>union(set(other_fnames))
</span></span><span style="display:flex;"><span>        chat_rel_fnames <span style="color:#f92672">=</span> set()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        fnames <span style="color:#f92672">=</span> sorted(fnames)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>cache_missing:
</span></span><span style="display:flex;"><span>            fnames <span style="color:#f92672">=</span> tqdm(fnames)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache_missing <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> fname <span style="color:#f92672">in</span> fnames:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> Path(fname)<span style="color:#f92672">.</span>is_file():
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> fname <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>warned_files:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> Path(fname)<span style="color:#f92672">.</span>exists():
</span></span><span style="display:flex;"><span>                        self<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>tool_error(
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Repo-map can&#39;t include </span><span style="color:#e6db74">{</span>fname<span style="color:#e6db74">}</span><span style="color:#e6db74">, it is not a normal file&#34;</span>
</span></span><span style="display:flex;"><span>                        )
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                        self<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>tool_error(
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Repo-map can&#39;t include </span><span style="color:#e6db74">{</span>fname<span style="color:#e6db74">}</span><span style="color:#e6db74">, it no longer exists&#34;</span>
</span></span><span style="display:flex;"><span>                        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>warned_files<span style="color:#f92672">.</span>add(fname)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># dump(fname)</span>
</span></span><span style="display:flex;"><span>            rel_fname <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_rel_fname(fname)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> fname <span style="color:#f92672">in</span> chat_fnames:
</span></span><span style="display:flex;"><span>                personalization[rel_fname] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>                chat_rel_fnames<span style="color:#f92672">.</span>add(rel_fname)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            tags <span style="color:#f92672">=</span> list(self<span style="color:#f92672">.</span>get_tags(fname, rel_fname))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tags <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> tags:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> tag<span style="color:#f92672">.</span>kind <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;def&#34;</span>:
</span></span><span style="display:flex;"><span>                    defines[tag<span style="color:#f92672">.</span>name]<span style="color:#f92672">.</span>add(rel_fname)
</span></span><span style="display:flex;"><span>                    key <span style="color:#f92672">=</span> (rel_fname, tag<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>                    definitions[key]<span style="color:#f92672">.</span>add(tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> tag<span style="color:#f92672">.</span>kind <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;ref&#34;</span>:
</span></span><span style="display:flex;"><span>                    references[tag<span style="color:#f92672">.</span>name]<span style="color:#f92672">.</span>append(rel_fname)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> references:
</span></span><span style="display:flex;"><span>            references <span style="color:#f92672">=</span> dict((k, list(v)) <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> defines<span style="color:#f92672">.</span>items())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        idents <span style="color:#f92672">=</span> set(defines<span style="color:#f92672">.</span>keys())<span style="color:#f92672">.</span>intersection(set(references<span style="color:#f92672">.</span>keys()))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        G <span style="color:#f92672">=</span> nx<span style="color:#f92672">.</span>MultiDiGraph()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> ident <span style="color:#f92672">in</span> idents:
</span></span><span style="display:flex;"><span>            definers <span style="color:#f92672">=</span> defines[ident]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> referencer, num_refs <span style="color:#f92672">in</span> Counter(references[ident])<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> definer <span style="color:#f92672">in</span> definers:
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># if referencer == definer:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">#    continue</span>
</span></span><span style="display:flex;"><span>                    G<span style="color:#f92672">.</span>add_edge(referencer, definer, weight<span style="color:#f92672">=</span>num_refs, ident<span style="color:#f92672">=</span>ident)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> references:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> personalization:
</span></span><span style="display:flex;"><span>            pers_args <span style="color:#f92672">=</span> dict(personalization<span style="color:#f92672">=</span>personalization, dangling<span style="color:#f92672">=</span>personalization)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            pers_args <span style="color:#f92672">=</span> dict()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            ranked <span style="color:#f92672">=</span> nx<span style="color:#f92672">.</span>pagerank(G, weight<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;weight&#34;</span>, <span style="color:#f92672">**</span>pers_args)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ZeroDivisionError</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># distribute the rank from each source node, across all of its out edges</span>
</span></span><span style="display:flex;"><span>        ranked_definitions <span style="color:#f92672">=</span> defaultdict(float)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> src <span style="color:#f92672">in</span> G<span style="color:#f92672">.</span>nodes:
</span></span><span style="display:flex;"><span>            src_rank <span style="color:#f92672">=</span> ranked[src]
</span></span><span style="display:flex;"><span>            total_weight <span style="color:#f92672">=</span> sum(
</span></span><span style="display:flex;"><span>                data[<span style="color:#e6db74">&#34;weight&#34;</span>] <span style="color:#66d9ef">for</span> _src, _dst, data <span style="color:#f92672">in</span> G<span style="color:#f92672">.</span>out_edges(src, data<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># dump(src, src_rank, total_weight)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> _src, dst, data <span style="color:#f92672">in</span> G<span style="color:#f92672">.</span>out_edges(src, data<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>                data[<span style="color:#e6db74">&#34;rank&#34;</span>] <span style="color:#f92672">=</span> src_rank <span style="color:#f92672">*</span> data[<span style="color:#e6db74">&#34;weight&#34;</span>] <span style="color:#f92672">/</span> total_weight
</span></span><span style="display:flex;"><span>                ident <span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;ident&#34;</span>]
</span></span><span style="display:flex;"><span>                ranked_definitions[(dst, ident)] <span style="color:#f92672">+=</span> data[<span style="color:#e6db74">&#34;rank&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ranked_tags <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        ranked_definitions <span style="color:#f92672">=</span> sorted(
</span></span><span style="display:flex;"><span>            ranked_definitions<span style="color:#f92672">.</span>items(), reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (fname, ident), rank <span style="color:#f92672">in</span> ranked_definitions:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># print(f&#34;{rank:.03f} {fname} {ident}&#34;)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> fname <span style="color:#f92672">in</span> chat_rel_fnames:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            ranked_tags <span style="color:#f92672">+=</span> list(definitions<span style="color:#f92672">.</span>get((fname, ident), []))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        rel_other_fnames_without_tags <span style="color:#f92672">=</span> set(
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>get_rel_fname(fname) <span style="color:#66d9ef">for</span> fname <span style="color:#f92672">in</span> other_fnames
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        fnames_already_included <span style="color:#f92672">=</span> set(rt[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> rt <span style="color:#f92672">in</span> ranked_tags)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        top_rank <span style="color:#f92672">=</span> sorted(
</span></span><span style="display:flex;"><span>            [(rank, node) <span style="color:#66d9ef">for</span> (node, rank) <span style="color:#f92672">in</span> ranked<span style="color:#f92672">.</span>items()], reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> rank, fname <span style="color:#f92672">in</span> top_rank:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> fname <span style="color:#f92672">in</span> rel_other_fnames_without_tags:
</span></span><span style="display:flex;"><span>                rel_other_fnames_without_tags<span style="color:#f92672">.</span>remove(fname)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> fname <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> fnames_already_included:
</span></span><span style="display:flex;"><span>                ranked_tags<span style="color:#f92672">.</span>append((fname,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> fname <span style="color:#f92672">in</span> rel_other_fnames_without_tags:
</span></span><span style="display:flex;"><span>            ranked_tags<span style="color:#f92672">.</span>append((fname,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ranked_tags
</span></span></code></pre></div><p>Here chatfiles are files are going to update and other files are all other files in the repo.</p>
<p>In get_ranked_tags, it uses Tree-sitter to analyze all files and generates a tag output file like:</p>
<pre tabindex="0"><code>[Tag(rel_fname=&#39;app/we.py&#39;, fname=&#39;/path/app/we.py&#39;, line=6, name=&#39;we&#39;, kind=&#39;def&#39;), 
Tag(rel_fname=&#39;app/we.py&#39;, fname=&#39;/path/app/we.py&#39;, line=7, name=&#39;__init__&#39;, kind=&#39;def&#39;),
 Tag(rel_fname=&#39;app/we.py&#39;, fname=&#39;/path/app/we.py&#39;, line=8, name=&#39;super&#39;, kind=&#39;ref&#39;), 
 Tag(rel_fname=&#39;app/we.py&#39;, fname=&#39;/path/app/we.py&#39;, line=8, name=&#39;__init__&#39;, kind=&#39;ref&#39;)]
</code></pre><ul>
<li>def indicates definitions in this file.</li>
<li>ref indicates references to definitions from other files.</li>
</ul>
<h2 id="summary">Summary</h2>
<p>The dream of each software engineer is to have AI assist us in our work. Aider partially achieves this dream. One major challenge when attempting a similar project is the context length limitation of LLMs, which prevents the inclusion of an entire repository. This project uses a repo map to reduce the context input to the LLM, which is a very clear and effective solution.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="https://www.tczhong.com/posts/llm/llamaindex_learning_tool_agents/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Learn LlamaIndex: Agents and Tools</span>
    </a>
    
    
</div>


  

  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'tczhong';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
