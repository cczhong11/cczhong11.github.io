<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.115.2">

    
    
    

<title>Learn LlamaIndex: Agents and Tools • TC blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Learn LlamaIndex: Agents and Tools"/>
<meta name="twitter:description" content="Learn llamaindex via source code"/>

<meta property="og:title" content="Learn LlamaIndex: Agents and Tools" />
<meta property="og:description" content="Learn llamaindex via source code" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.tczhong.com/posts/llm/llamaindex_learning_tool_agents/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-01-24T00:00:00+00:00" /><meta property="og:site_name" content="TC blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">








<link rel="stylesheet" href="https://www.tczhong.com/scss/hyde-hyde.3081c4981fb69a2783dd36ecfdd0e6ba7a158d4cbfdd290ebce8f78ba0469fc6.css" integrity="sha256-MIHEmB&#43;2mieD3Tbs/dDmunoVjUy/3SkOvOj3i6BGn8Y=">


<link rel="stylesheet" href="https://www.tczhong.com/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.tczhong.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://www.tczhong.com/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.tczhong.com/">TC blog</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://avatars2.githubusercontent.com/u/7358252?s=460&amp;v=4" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         I am who I am. Love Cloud and Data science 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">TC blog</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="https://www.tczhong.com/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/about/hello">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/tianchen_zhong.pdf">
						<span>My Resume</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.tczhong.com/posts/project/index.html">
						<span>Project</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	
	
	<a href="https://github.com/cczhong11" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/tianchen-zhong" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/7112540" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="mailto:tczhong24@gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Learn LlamaIndex: Agents and Tools</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Jan 1, 2024
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/agents">AGENTS</a>
              •
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/llamaindex">LLAMAINDEX</a>
              •
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/llm">LLM</a>
              •
          
              <a class="badge badge-category" href="https://www.tczhong.com/categories/llmops">LLMOPS</a>
              
          
      
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 10 min read
</div>


  </header>
  
  
  <div class="post">
    <h1 id="background">Background</h1>
<p>LlamaIndex is an exceptional open-source project that offers a wide range of capabilities. It serves as a valuable resource for practitioners and developers seeking to enhance their Large Language Models (LLMs) with versatile tools and data. Designed to foster seamless integration between custom data sources and LLM applications, LlamaIndex represents a simple yet highly flexible data framework.Driven by the rapidly growing demand for sophisticated language processing models, LlamaIndex aims to empower users by facilitating effortless data retrieval and utilization. With LlamaIndex, developers can streamline their workflow and enrich their language models with a diverse range of data sources.</p>
<p>However, as the content of LlamaIndex is extensive and diverse on a large scale, it can be challenging to grasp the entire project. Therefore, I am interested in learning LlamaIndex through its source code.</p>
<p>In this blog series, I will document my learning experience with llamaindex. Today I will focus on Tools and Agents.</p>
<h2 id="tools">Tools</h2>
<p>Having proper tool abstractions is crucial when it comes to building effective data agents. In the context of agents, tools are designed as a set of abstractions similar to API interfaces, but specifically intended for agent use rather than for humans. These tools allow users to perform various functions and interact with the agent in a structured manner.</p>
<p>Tool is implemented by defining a special method called &ldquo;<strong>call</strong>&rdquo;. This method acts as the entry point for the tool and handles the relevant functionality. Additionally, a tool also provides some basic metadata such as name, description, and function schema. This metadata helps users understand the purpose and capabilities of each tool.</p>
<p>However, defining a single tool may not always be sufficient for complex tasks. That&rsquo;s where Tool Specs come into play. A Tool Spec allows users to define a complete API specification for a service, which can then be converted into a list of individual tools. By encapsulating multiple tools under a common specification, Tool Specs provide a more structured and organized approach to interacting with complex agent functionalities.</p>
<p>With a Tool Spec, users can easily access and utilize a range of tools that collectively serve a specific purpose or provide a comprehensive set of functionalities. This ensures flexibility and convenience when working with diverse agent capabilities or complex data tasks.</p>
<h3 id="tool-example">Tool Example</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_numbers</span>(x: int, y: int) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Adds the two numbers together and returns the result.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>function_tool <span style="color:#f92672">=</span> FunctionTool<span style="color:#f92672">.</span>from_defaults(fn<span style="color:#f92672">=</span>add_numbers)
</span></span></code></pre></div><h3 id="toolspec-example">ToolSpec Example</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CodeInterpreterToolSpec</span>(BaseToolSpec):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Code Interpreter tool spec.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    WARNING: This tool provides the Agent access to the `subprocess.run` command.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Arbitrary code execution is possible on the machine running this tool.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This tool is not recommended to be used in a production setting, and would require heavy sandboxing or virtual machines
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    spec_functions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;code_interpreter&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">code_interpreter</span>(self, code: str):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        A function to execute python code, and return the stdout and stderr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        You should import any libraries that you wish to use. You have access to any libraries the user has installed.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        The code passed to this functuon is executed in isolation. It should be complete at the time it is passed to this function.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        You should interpret the output and errors returned from this function, and attempt to fix any problems.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        If you cannot fix the error, show the code to the user and ask for help
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        It is not possible to return graphics or other complicated data from this function. If the user cannot see the output, save it to a file and tell the user.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>run(
</span></span><span style="display:flex;"><span>            [sys<span style="color:#f92672">.</span>executable, <span style="color:#e6db74">&#34;-c&#34;</span>, code], stdout<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE, stderr<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;StdOut:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{</span>result<span style="color:#f92672">.</span>stdout<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">StdErr:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{</span>result<span style="color:#f92672">.</span>stderr<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>In this example, we have a toolspec that defines a set of spec functions. To expose the required functions to agents, we have used a list to define them. It is crucial for agents to understand the functionality and necessary arguments of each function, which is why the docstring plays a critical role. The docstring provides a clear description of what the function does and the arguments it requires, aiding agents in their understanding.</p>
<h3 id="how-to-use-tool-and-toolspec">How to use Tool and ToolSpec</h3>
<p>Llamaindex will parse tool specs and generate tool metadata for you. You can use the tool directly in the agent.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>code_spec <span style="color:#f92672">=</span> CodeInterpreterToolSpec()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent <span style="color:#f92672">=</span> OpenAIAgent<span style="color:#f92672">.</span>from_tools(code_spec<span style="color:#f92672">.</span>to_tool_list())
</span></span></code></pre></div><h3 id="source-code-understanding">Source code understanding</h3>
<p>In the <a href="https://github.com/run-llama/llama_index/blob/main/llama-index-core/llama_index/core/tools/tool_spec/base.py">source code</a>, we can see that the tool spec is parsed into a list of tools. Then we can use the tool list to initialize the agent.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> llama_index.tools.utils <span style="color:#f92672">import</span> create_schema_from_function
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseToolSpec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Base tool spec class.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># list of functions that you&#39;d want to convert to spec</span>
</span></span><span style="display:flex;"><span>    spec_functions: List[Union[str, Tuple[str, str]]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_fn_schema_from_fn_name</span>(self, fn_name: str) <span style="color:#f92672">-&gt;</span> Optional[Type[BaseModel]]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Return map from function name.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Return type is Optional, meaning that the schema can be None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        In this case, it&#39;s up to the downstream tool implementation to infer the schema.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> fn <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>spec_functions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> fn <span style="color:#f92672">==</span> fn_name:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> create_schema_from_function(fn_name, getattr(self, fn_name))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid function name: </span><span style="color:#e6db74">{</span>fn_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_metadata_from_fn_name</span>(self, fn_name: str) <span style="color:#f92672">-&gt;</span> Optional[ToolMetadata]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Return map from function name.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Return type is Optional, meaning that the schema can be None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        In this case, it&#39;s up to the downstream tool implementation to infer the schema.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            func <span style="color:#f92672">=</span> getattr(self, fn_name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">AttributeError</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> fn_name
</span></span><span style="display:flex;"><span>        docstring <span style="color:#f92672">=</span> func<span style="color:#f92672">.</span>__doc__ <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        description <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}{</span>signature(func)<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{</span>docstring<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        fn_schema <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_fn_schema_from_fn_name(fn_name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ToolMetadata(name<span style="color:#f92672">=</span>name, description<span style="color:#f92672">=</span>description, fn_schema<span style="color:#f92672">=</span>fn_schema)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_tool_list</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        func_to_metadata_mapping: Optional[Dict[str, ToolMetadata]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> List[FunctionTool]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Convert tool spec to list of tools.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        func_to_metadata_mapping <span style="color:#f92672">=</span> func_to_metadata_mapping <span style="color:#f92672">or</span> {}
</span></span><span style="display:flex;"><span>        tool_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> func_spec <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>spec_functions:
</span></span><span style="display:flex;"><span>            func_sync <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            func_async <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> isinstance(func_spec, str):
</span></span><span style="display:flex;"><span>                func <span style="color:#f92672">=</span> getattr(self, func_spec)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> asyncio<span style="color:#f92672">.</span>iscoroutinefunction(func):
</span></span><span style="display:flex;"><span>                    func_async <span style="color:#f92672">=</span> func
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    func_sync <span style="color:#f92672">=</span> func
</span></span><span style="display:flex;"><span>                metadata <span style="color:#f92672">=</span> func_to_metadata_mapping<span style="color:#f92672">.</span>get(func_spec, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> metadata <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                    metadata <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_metadata_from_fn_name(func_spec)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            tool <span style="color:#f92672">=</span> FunctionTool<span style="color:#f92672">.</span>from_defaults(
</span></span><span style="display:flex;"><span>                fn<span style="color:#f92672">=</span>func_sync,
</span></span><span style="display:flex;"><span>                async_fn<span style="color:#f92672">=</span>func_async,
</span></span><span style="display:flex;"><span>                tool_metadata<span style="color:#f92672">=</span>metadata,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            tool_list<span style="color:#f92672">.</span>append(tool)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tool_list
</span></span></code></pre></div><p>Here fn_schema is a pydantic model that defines the input and output of the function. In this <a href="https://docs.pydantic.dev/latest/concepts/models/">doc</a> explains what is pydantic model and it provide a easy way to dump json format data.</p>
<p>Inside <a href="https://github.com/run-llama/llama_index/blob/main/llama-index-core/llama_index/core/tools/utils.py#L7">llama_index/tools/utils.py</a> we can understand create_schema_from_function logic.</p>
<h2 id="agents">Agents</h2>
<p>In the realm of advanced language models, one crucial component that drives efficient and accurate results is an &ldquo;agent.&rdquo; Agents serve as the backbone of automated reasoning and decision-making processes, providing a bridge between user queries and the execution of tasks. Through their ability to break down complex questions, select external tools and parameters, plan out tasks, and utilize memory modules, agents streamline the interaction between users and language models. In this blog post, we will delve deeper into the key components of agents and explore how they facilitate the seamless functioning of the LlamaIndex.</p>
<p>Choosing an external tool and defining parameters. Another vital responsibility of agents is to determine the most appropriate external tool to employ for executing user queries. Based on the requirements of a particular task, agents evaluate a range of tools and select the one that will yield the best results. Additionally, agents are equipped with the intelligence to derive optimal parameters for these tools, fine-tuning their usage for each unique situation. This decision-making process is critical in ensuring the effectiveness and efficiency of the chosen tools.</p>
<p>Agents excel in their ability to strategize and plan out a sequence of tasks necessary to accomplish a user&rsquo;s query. Drawing upon their knowledge and understanding of various tools and methodologies, agents devise a plan of action that will yield the best results. This planning process is crucial in ensuring that the agent can execute the task in the most efficient manner possible.</p>
<h3 id="agentworker-and-agentrunner">AgentWorker and AgentRunner</h3>
<p><img src="https://tczimg.s3.amazonaws.com/vscode/28ef64bec90449a491d4f486720e9aca.png" alt=""></p>
<p>LlamaIndex &ldquo;agents&rdquo; are composed of <code>AgentRunner</code> objects that interact with <code>AgentWorkers</code>:</p>
<ul>
<li><code>AgentRunner</code>s are orchestrators that store state (including conversational memory), create and maintain tasks, run steps through each task, and offer the user-facing, high-level interface for users to interact with.</li>
<li><code>AgentWorker</code>s <strong>control the step-wise execution of a Task</strong>. Given an input step, an agent worker is responsible for generating the next step. They can be initialized with parameters and act upon state passed down from the Task/TaskStep objects, but do not inherently store state themselves. The outer <code>AgentRunner</code> is responsible for calling an <code>AgentWorker</code> and collecting/aggregating the results.</li>
</ul>
<h3 id="task-and-step">Task and Step</h3>
<p>Here Llamaindex follow <a href="https://agentprotocol.ai/protocol">agent protocol</a>.</p>
<ul>
<li><code>Task</code>: high-level task, takes in a user query + passes along other info like memory</li>
<li><code>TaskStep</code>: represents a single step. Feed this in as input to <code>AgentWorker</code>, get back a <code>TaskStepOutput</code>. Completing a <code>Task</code> can involve multiple <code>TaskStep</code>.</li>
<li><code>TaskStepOutput</code>: Output from a given step execution. Outputs whether or not a task is done.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TaskStep</span>(BaseModel):
</span></span><span style="display:flex;"><span>    task_id: str
</span></span><span style="display:flex;"><span>    step_id: str
</span></span><span style="display:flex;"><span>    input: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    step_state: Dict[str, Any] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    next_steps: Dict[str, <span style="color:#e6db74">&#34;TaskStep&#34;</span>] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    prev_steps: Dict[str, <span style="color:#e6db74">&#34;TaskStep&#34;</span>] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    is_ready: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_next_step</span>(self, step_id: str, input: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, step_state: Optional[Dict[str, Any]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;TaskStep&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TaskStep(task_id<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>task_id, step_id<span style="color:#f92672">=</span>step_id, input<span style="color:#f92672">=</span>input, step_state<span style="color:#f92672">=</span>step_state <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>step_state)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">link_step</span>(self, next_step: <span style="color:#e6db74">&#34;TaskStep&#34;</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>next_steps[next_step<span style="color:#f92672">.</span>step_id] <span style="color:#f92672">=</span> next_step
</span></span><span style="display:flex;"><span>        next_step<span style="color:#f92672">.</span>prev_steps[self<span style="color:#f92672">.</span>step_id] <span style="color:#f92672">=</span> self
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TaskStepOutput</span>(BaseModel):
</span></span><span style="display:flex;"><span>    output: Any
</span></span><span style="display:flex;"><span>    task_step: TaskStep
</span></span><span style="display:flex;"><span>    next_steps: List[TaskStep]
</span></span><span style="display:flex;"><span>    is_last: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Task</span>(BaseModel):
</span></span><span style="display:flex;"><span>    task_id: str
</span></span><span style="display:flex;"><span>    input: str
</span></span><span style="display:flex;"><span>    memory: Any
</span></span><span style="display:flex;"><span>    callback_manager: Any
</span></span><span style="display:flex;"><span>    extra_state: Dict[str, Any] <span style="color:#f92672">=</span> {}
</span></span></code></pre></div><p>TaskStep is a link list, it has next_steps and prev_steps. It is a way to represent the flow of the task.</p>
<h3 id="agentworker">AgentWorker</h3>
<p><a href="https://github.com/run-llama/llama_index/blob/main/llama-index-core/llama_index/core/agent/types.py">code</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseAgentWorker</span>(PromptMixin):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Base agent worker.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize_step</span>(self, task: Task, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> TaskStep:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Initialize step from task.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_step</span>(self, step: TaskStep, task: Task, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> TaskStepOutput:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Run step.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">finalize_task</span>(self, task: Task, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Finalize task, after all the steps are completed.&#34;&#34;&#34;</span>
</span></span></code></pre></div><h3 id="agentrunner">AgentRunner</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseAgentRunner</span>(BaseAgent, ABC):
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_task</span>(self, input: str, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> Task:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_task</span>(self, task_id: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_tasks</span>(self, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> List[Task]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_task</span>(self, task_id: str, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> Task:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_upcoming_steps</span>(self, task_id: str, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> List[TaskStep]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_completed_steps</span>(self, task_id: str, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> List[TaskStepOutput]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_completed_step</span>(self, task_id: str, step_id: str, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> TaskStepOutput:
</span></span><span style="display:flex;"><span>        completed_steps <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_completed_steps(task_id, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> step_output <span style="color:#f92672">in</span> completed_steps:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> step_output<span style="color:#f92672">.</span>task_step<span style="color:#f92672">.</span>step_id <span style="color:#f92672">==</span> step_id:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> step_output
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Could not find step_id: </span><span style="color:#e6db74">{</span>step_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_step</span>(self, task_id: str, input: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, step: Optional[TaskStep] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> TaskStepOutput:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># here call LLM to run step and get next step</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">finalize_response</span>(self, task_id: str, step_output: Optional[TaskStepOutput] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@abstractmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">undo_step</span>(self, task_id: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TaskState</span>(BaseModel):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Task state.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    task: Task <span style="color:#f92672">=</span> Field(<span style="color:#f92672">...</span>, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Task.&#34;</span>)
</span></span><span style="display:flex;"><span>    step_queue: Deque[TaskStep] <span style="color:#f92672">=</span> Field(
</span></span><span style="display:flex;"><span>        default_factory<span style="color:#f92672">=</span>deque, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Task step queue.&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    completed_steps: List[TaskStepOutput] <span style="color:#f92672">=</span> Field(
</span></span><span style="display:flex;"><span>        default_factory<span style="color:#f92672">=</span>list, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Completed step outputs.&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AgentState</span>(BaseModel):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Agent state.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    task_dict: Dict[str, TaskState] <span style="color:#f92672">=</span> Field(
</span></span><span style="display:flex;"><span>        default_factory<span style="color:#f92672">=</span>dict, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Task dictionary.&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AgentRunner</span>(BaseAgentRunner):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Agent runner.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Top-level agent orchestrator that can create tasks, run each step in a task,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    or run a task e2e. Stores state and keeps track of tasks.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        agent_worker (BaseAgentWorker): step executor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        chat_history (Optional[List[ChatMessage]], optional): chat history. Defaults to None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        state (Optional[AgentState], optional): agent state. Defaults to None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        memory (Optional[BaseMemory], optional): memory. Defaults to None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        llm (Optional[LLM], optional): LLM. Defaults to None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        callback_manager (Optional[CallbackManager], optional): callback manager. Defaults to None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        init_task_state_kwargs (Optional[dict], optional): init task state kwargs. Defaults to None.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        agent_worker: BaseAgentWorker,
</span></span><span style="display:flex;"><span>        chat_history: Optional[List[ChatMessage]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        state: Optional[AgentState] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        memory: Optional[BaseMemory] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        llm: Optional[LLM] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        callback_manager: Optional[CallbackManager] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        init_task_state_kwargs: Optional[dict] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        delete_task_on_finish: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        default_tool_choice: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;auto&#34;</span>,
</span></span><span style="display:flex;"><span>        verbose: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Initialize.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>agent_worker <span style="color:#f92672">=</span> agent_worker
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> state <span style="color:#f92672">or</span> AgentState()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory <span style="color:#f92672">=</span> memory <span style="color:#f92672">or</span> ChatMemoryBuffer<span style="color:#f92672">.</span>from_defaults(chat_history, llm<span style="color:#f92672">=</span>llm)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>llm <span style="color:#f92672">=</span> llm
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_task</span>(self, input: str, <span style="color:#f92672">**</span>kwargs: Any) <span style="color:#f92672">-&gt;</span> Task:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create task.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>init_task_state_kwargs:
</span></span><span style="display:flex;"><span>            extra_state <span style="color:#f92672">=</span> kwargs<span style="color:#f92672">.</span>pop(<span style="color:#e6db74">&#34;extra_state&#34;</span>, {})
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;extra_state&#34;</span> <span style="color:#f92672">in</span> kwargs:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Cannot specify both `extra_state` and `init_task_state_kwargs`&#34;</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                extra_state <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>init_task_state_kwargs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        callback_manager <span style="color:#f92672">=</span> kwargs<span style="color:#f92672">.</span>pop(<span style="color:#e6db74">&#34;callback_manager&#34;</span>, self<span style="color:#f92672">.</span>callback_manager)
</span></span><span style="display:flex;"><span>        task <span style="color:#f92672">=</span> Task(
</span></span><span style="display:flex;"><span>            input<span style="color:#f92672">=</span>input,
</span></span><span style="display:flex;"><span>            memory<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>memory,
</span></span><span style="display:flex;"><span>            extra_state<span style="color:#f92672">=</span>extra_state,
</span></span><span style="display:flex;"><span>            callback_manager<span style="color:#f92672">=</span>callback_manager,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">**</span>kwargs,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># get initial step from task, and put it in the step queue</span>
</span></span><span style="display:flex;"><span>        initial_step <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>agent_worker<span style="color:#f92672">.</span>initialize_step(task)
</span></span><span style="display:flex;"><span>        task_state <span style="color:#f92672">=</span> TaskState(
</span></span><span style="display:flex;"><span>            task<span style="color:#f92672">=</span>task,
</span></span><span style="display:flex;"><span>            step_queue<span style="color:#f92672">=</span>deque([initial_step]),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># add it to state</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>task_dict[task<span style="color:#f92672">.</span>task_id] <span style="color:#f92672">=</span> task_state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> task
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_run_step</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        task_id: str,
</span></span><span style="display:flex;"><span>        step: Optional[TaskStep] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        input: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        mode: ChatResponseMode <span style="color:#f92672">=</span> ChatResponseMode<span style="color:#f92672">.</span>WAIT,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">**</span>kwargs: Any,
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> TaskStepOutput:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Execute step.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        task <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>get_task(task_id)
</span></span><span style="display:flex;"><span>        step_queue <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>get_step_queue(task_id)
</span></span><span style="display:flex;"><span>        step <span style="color:#f92672">=</span> step <span style="color:#f92672">or</span> step_queue<span style="color:#f92672">.</span>popleft()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> input <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            step<span style="color:#f92672">.</span>input <span style="color:#f92672">=</span> input
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># append cur_step_output next steps to queue</span>
</span></span><span style="display:flex;"><span>        next_steps <span style="color:#f92672">=</span> cur_step_output<span style="color:#f92672">.</span>next_steps
</span></span><span style="display:flex;"><span>        step_queue<span style="color:#f92672">.</span>extend(next_steps)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># add cur_step_output to completed steps</span>
</span></span><span style="display:flex;"><span>        completed_steps <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>get_completed_steps(task_id)
</span></span><span style="display:flex;"><span>        completed_steps<span style="color:#f92672">.</span>append(cur_step_output)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> cur_step_output
</span></span></code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>In this blog post, we have explored the key components of LlamaIndex agents and tools. We have learned how tools and agents work together to facilitate the seamless functioning of the LlamaIndex. By understanding the inner workings of these components, we can gain a deeper appreciation for the capabilities of LlamaIndex and how it can be leveraged to enhance language models. In the next blog post, we will continue our exploration of LlamaIndex and delve into more advanced topics. Stay tuned for more insights and learning experiences!</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="https://www.tczhong.com/posts/windows/encoding_problem/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Windows encoding error</span>
    </a>
    
    
</div>


  

  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'tczhong';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
