<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content=""/>

  
  <meta name="description" content="This blog will discuss several ways to read static file in Samza"/>
  

  

  
  <link rel="canonical" href="http://www.tczhong.com/posts/cc/samzastaticfile/"/>

  

  <title>Read Static file in Apache Samza &middot; TC blog</title>

  <link rel="shortcut icon" href="http://www.tczhong.com/images/favicon.ico"/>
  <link rel="stylesheet" href="http://www.tczhong.com/css/animate.min.css"/>
  <link rel="stylesheet" href="http://www.tczhong.com/css/remixicon.css"/>
  <link rel="stylesheet" href="http://www.tczhong.com/css/zozo.css"/>
  <link rel="stylesheet" href="http://www.tczhong.com/css/highlight.css"/>

  
  
</head>

<body>
<div class="main animated">
  <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="http://www.tczhong.com/posts/">Posts</a>
      </li>
      
      <li>
        <a href="http://www.tczhong.com/about/hello">About</a>
      </li>
      
      <li>
        <a href="http://www.tczhong.com/tianchen_zhong.pdf">My Resume</a>
      </li>
      
      <li>
        <a href="http://www.tczhong.com/posts/project/index.html">Project</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

  <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="http://www.tczhong.com/">
          <span>TC blog</span>
          <img src="http://www.tczhong.com/img/kirby.png"/>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title"></p>
      <div class="my_socials">
        
        <a href="http://www.tczhong.com/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post_page">
      <div class="post animated fadeInDown">
        <div class="post_title post_detail_title">
          <h2><a href='http://www.tczhong.com/posts/cc/samzastaticfile/'>Read Static file in Apache Samza</a></h2>
          <span class="date">2018.12.05</span>
        </div>
        <div class="post_content markdown"><p><img src="https://samza.apache.org/img/samza-logo.png" alt=""></p>
<h1 id="scenario">Scenario</h1>
<p>Apache Samza is a stream processing framework developed by Linkedin. It allows we to build stateful applications that process data in real-time and it could read data from Apache Kafka smoothly. It has handful of examples on how to read stream data from Kafka topic. However, it did not include any working examples for Apache Samza to consume static data and stream data at the same time in stream processing. In real life, we need to consume static data firstly and then make decisions based on static data and stream data. In Apache Spark streaming, it is possible to do this. In Apache Samza, it is not supported correctly.</p>
<h2 id="attempt-with-official-api">Attempt with official API</h2>
<p>In the documentation, it provides the option to read data from <a href="https://samza.apache.org/learn/documentation/1.0.0/connectors/hdfs.html">HDFS</a>. It is said:</p>
<blockquote>
<p>When all partitions being processed by the task are at the end of stream (i.e., EOF has been reached for all files), the Samza job exits automatically</p>
</blockquote>
<p>This warning is only for one HDFS consumer, if we used a Kafka and HDFS consumer, it would not exit.</p>
<p>One thing it is also mentioned in the documentation:</p>
<blockquote>
<p>Samza supports Avro natively, and it’s easy to extend to other serialization formats. To support non-Avro input formats, you can implement the SingleFileHdfsReader interface.</p>
</blockquote>
<p>If I wanted to read JSON file, I need to implement that interface. However, it did not provide any examples online, and I did not continue trying this method.</p>
<h2 id="hacker-way-1">Hacker way 1</h2>
<p>One way to do this is to send static data as a stream. We do the following steps:</p>
<ol>
<li>Create a <code>data-stream</code> in Kafka cluster.</li>
<li>Write Data producer code to read data in the static file line by line.</li>
<li>Send JSON format data to all partitions in Kafka cluster with data-stream.</li>
<li>Wait for Samza consume all data in the Kafka topic.</li>
<li>Begin to send stream data.</li>
</ol>
<p>If we have multiple partitions in Kafka, we need to send data to all partitions if the static data is needed in all partitions. The reason is in Apache Samza, and it will start a Samza job in each partition. The KeyValueStore is not shared with different partitions. It is easy to get <code>NullPointerException</code> if we did not send to all partitions.</p>
<p>Wait after sending data is also very important. The reason is in the <a href="https://samza.apache.org/learn/documentation/0.14/container/streams.html%10">documentation</a></p>
<blockquote>
<p>If a job is consuming messages from more than one input stream, and all input streams have messages available, messages are processed in a round robin fashion by default.</p>
</blockquote>
<p>Therefore, if we did not wait after sending static data in the topic, we would also get <code>NullPointerException</code> because Consumer did not read that data and save them in KeyValueStore.</p>
<h2 id="hacker-way-2">Hacker way 2</h2>
<p>Another way is to just put data in Java Maven Project resource folder. In the Samza Consumer code initialization step, we could read data from the resource folder and save them in KeyValueStore. We need to do the following things.</p>
<ol>
<li>
<p>Create a new folder under <code>src/main/resources</code> and put static data here.</p>
</li>
<li>
<p>Add the following code snippets in <code>pom.xml</code>.
<img src="../xml.png" alt=""></p>
</li>
<li>
<p>In the source code, put the following code to read data.
<img src="../java.png" alt=""></p>
</li>
</ol>
<p>This way is more natural than the previous method.</p>
<h1 id="conclusion">Conclusion</h1>
<p>In the beginning, I thought it should support in the Apache Samza. However, after researching, it is not supported in the official documentation, and it seemed not a common use case. Then I used some hacker ways to avoid using official HDFS consumer. I spent lots of time to debug and make the first hacking method work. My experience taught me I should read the documentation carefully before writing any code. The second way is much easier and could achieve the same result as the first way.</p>
</div>
        <div class="post_footer">
          
        </div>
      </div>
      
      
    </div>
  </div>
  <a id="back_to_top" href="#" class="back_to_top"><span>△</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://zeuk.me">Designed by Zeuk,</a>
    <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
  </div>

  <div class="footer_slogan">
    <span></span>
  </div>
</footer>



<script src="http://www.tczhong.com/js/jquery-3.3.1.min.js"></script>
<script src="http://www.tczhong.com/js/zozo.js"></script>
<script src="http://www.tczhong.com/js/highlight.pack.js"></script>
<link  href="http://www.tczhong.com/css/fancybox.min.css" rel="stylesheet">
<script src="http://www.tczhong.com/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>





<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "tczhong" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</body>
</html>
